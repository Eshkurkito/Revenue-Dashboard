<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Informe de propietario ¬∑ {{ apto or '‚Äî' }}</title>
<style>
  * { box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color: #111827;
    margin: 0;
    padding: 16px 18px;
    font-size: 12px;
  }

  h1,h2,h3 { margin: 0 0 8px 0; font-weight:600; color:#122029; }
  .muted { color: #6b7280; font-size: 11.5px; }

  .header { width: 100%; margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }
  .header-table { width: 100%; border-collapse: collapse; }
  .header-table td { vertical-align: middle; }
  .logo { height: 104px; }

  .kpis { width: 100%; border-collapse: separate; border-spacing: 8px; margin: 6px 0 8px 0; }
  .kpi {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px 12px;
    background: #f8fafc;
  }
  .kpi h4 { margin: 0 0 4px 0; font-size: 12px; color: #374151; }
  .kpi .v { font-size: 18px; font-weight: 700; color:#17384a; }
  .kpi .ly { font-size: 11px; color: #6b7280; }

  .card {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px;
    margin-top: 10px;
    page-break-inside: avoid;
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    -webkit-page-break-inside: avoid;
    background: #ffffff;
  }
  .card h3 { font-size: 14px; margin: 0 0 6px 0; color: #1f2937; }

  img.chart { width: 100%; height: auto; border: 1px solid #e5e7eb; border-radius: 8px; display: block; }
  .chart-portal { width: 100% !important; margin: 0 auto; }

  .table { width: 100%; border-collapse: collapse; font-size: 11.5px; color:#111827; }
  .table th, .table td { border: 1px solid #e5e7eb; padding: 6px 8px; }
  .table th { background: #f3f4f6; text-align: left; font-weight:600; }

  /* Evitar cortes dentro de tablas y repetir encabezados en PDF */
  .avoid-break-block {
    display: block;
    width: 100%;
    page-break-inside: avoid;
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    -webkit-page-break-inside: avoid;
  }
  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }
  tbody { display: table-row-group; }
  .table tbody tr { page-break-inside: avoid; break-inside: avoid; -webkit-column-break-inside: avoid; }

  .comments { white-space: pre-wrap; min-height: 60px; }

  @media print {
    body { padding: 12px; }
    .card { box-shadow: none; }
  }
</style>
</head>
<body>
  {%- macro paginated_table(headers, rows, cols, rows_per_page=20, table_classes='table') -%}
    {%- for start in range(0, rows|length, rows_per_page) -%}
      <div class="avoid-break-block" style="margin-bottom:6px;">
        <table class="{{ table_classes }}" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              {%- for h in headers -%}
                <th style="text-align:{{ h.align|default('left') }}; padding:6px; border:1px solid #e5e7eb;">{{ h.label }}</th>
              {%- endfor -%}
            </tr>
          </thead>
          <tbody>
            {%- for r in rows[start:start+rows_per_page] -%}
              <tr>
                {%- for c in cols -%}
                  <td style="text-align:{{ c.align|default('left') }}; padding:6px; border:1px solid #e5e7eb;">
-                    {{ attribute(r, c.key) }}
+                    {{ r[c.key] }}
                  </td>
                {%- endfor -%}
              </tr>
            {%- endfor -%}
          </tbody>
        </table>
      </div>
      {%- if start + rows_per_page < rows|length -%}
        <div style="page-break-after: always;"></div>
      {%- endif -%}
    {%- endfor -%}
  {%- endmacro -%}
  <!-- full-bleed removed (background now white) -->
  <div class="sheet">
  <div class="header">
    <table class="header-table">
      <tr>
        <td>
          <h2>Informe de propietario</h2>
          <div class="muted">
            Apartamento: <b>{{ apto or '‚Äî' }}</b> ¬∑ Propietario: <b>{{ owner or '‚Äî' }}</b><br>
            Periodo ACT: <b>{{ period_act }}</b> ¬∑ Periodo LY: <b>{{ period_ly }}</b>
          </div>

          <!-- Progreso ingresos vs previsi√≥n -->
          <div style="margin-top:8px;">
            <div style="font-size:12px; color:#374151; margin-bottom:4px;">
              Ingresos ACT: <strong>{{ act.ingresos }}</strong> ¬∑ Previsi√≥n periodo: <strong>{{ forecast_total }}</strong> ¬∑ <strong>{{ forecast_progress_pct }}</strong>
            </div>
            <div style="background:#e5e7eb; border-radius:8px; height:12px; width:280px;">
              <table style="height:12px; width:100%; border-collapse:collapse; table-layout:fixed;">
                <tr>
                  <td width="{{ forecast_progress_pct }}" style="background:#2e485f; height:12px; border-radius:8px;"></td>
                  <td style="background:transparent; height:12px;"></td>
                </tr>
              </table>
            </div>
          </div>

        </td>
        <td style="text-align:right; width:180px;">
          {% if logo_b64 %}
            <img class="logo" src="data:image/png;base64,{{ logo_b64 }}" alt="Logo">
          {% endif %}
        </td>
      </tr>
    </table>
  </div>

  <table class="kpis">
    <tr>
      <td class="kpi">
        <h4>Ingresos (ACT)</h4>
        <div class="v">{{ act.ingresos }}</div>
        <div class="ly">LY: {{ ly.ingresos }}</div>
      </td>
      <td class="kpi">
        <h4>ADR (ACT)</h4>
        <div class="v">{{ act.adr }}</div>
        <div class="ly">LY: {{ ly.adr }}</div>
      </td>
      <td class="kpi">
        <h4>Noches vendidas (ACT)</h4>
        <div class="v">{{ act.noches }}</div>
        <div class="ly">LY: {{ ly.noches }}</div>
      </td>
    </tr>
  </table>

  <div class="card">
    <div class="avoid-break-block">
      <h3>Indicadores operativos</h3>
      <table class="table">
        <thead><tr><th>Estancia media (LOS)</th><th>Antelaci√≥n media</th></tr></thead>
        <tbody><tr><td>{{ los_avg }} d√≠as</td><td>{{ lead_avg }} d√≠as</td></tr></tbody>
      </table>
    </div>
  </div>
  
  <div class="card">
    <div class="avoid-break-block">
      <h3>Reservas por portal (periodo)</h3>
      <table class="table">
        <thead><tr><th>Portal</th><th>Reservas</th></tr></thead>
        <tbody>
          {% for r in portal_rows %}
          <tr><td>{{ r.Portal }}</td><td>{{ r.Reservas }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="card">
    <h3>ADR por {{ gran_label }} (ACT vs LY)</h3>
    <img class="chart" src="data:image/png;base64,{{ chart_adr }}" alt="ADR">
  </div>

  <div class="card avoid-break-block" style="margin-top:4mm;">
    <div class="avoid-break-block">
      <h3>Desglose mensual</h3>
      {% set monthly_headers = [
        {'label':'Mes'},
        {'label':'Ingresos (ACT)','align':'right'},
        {'label':'Ingresos (LY)','align':'right'},
        {'label':'Previsi√≥n','align':'right'},
        {'label':'ADR (ACT)','align':'right'},
        {'label':'ADR (LY)','align':'right'},
        {'label':'Ocupaci√≥n (ACT)','align':'right'},
        {'label':'Ocupaci√≥n (LY)','align':'right'},
        {'label':'Noches (ACT)','align':'right'},
        {'label':'Noches (LY)','align':'right'}
      ] %}
      {% set monthly_cols = [
        {'key':'mes'},
        {'key':'ing_act','align':'right'},
        {'key':'ing_ly','align':'right'},
        {'key':'forecast','align':'right'},
        {'key':'adr_act','align':'right'},
        {'key':'adr_ly','align':'right'},
        {'key':'ocup_act','align':'right'},
        {'key':'ocup_ly','align':'right'},
        {'key':'nights_act','align':'right'},
        {'key':'nights_ly','align':'right'}
      ] %}
      {{ paginated_table(monthly_headers, monthly_rows, monthly_cols, rows_per_page=20, table_classes='table') }}
    </div>
  </div>

  {# Si se solicitaron varios pisos, mostrar un desglose mensual por cada piso #}
   {% if monthly_by_property %}
     {% for mb in monthly_by_property %}
       <div class="card">
         <div class="avoid-break-block">
           <h3>Desglose mensual ‚Äî {{ mb.apto }}</h3>
           {% set mb_headers = monthly_headers %}
           {% set mb_cols = monthly_cols %}
           {{ paginated_table(mb_headers, mb.monthly_rows, mb_cols, rows_per_page=20, table_classes='table') }}
         </div>
       </div>
     {% endfor %}
   {% endif %}

  <!-- Tabla unificada: Reservas por portal + Ingresos + Share -->
  <div class="card">
    <div class="avoid-break-block">
      <h3>Reservas por portal (periodo)</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Portal</th>
            <th>Reservas</th>
            <th style="text-align:right">% reservas</th>
            <th style="text-align:right">Ingresos</th>
          </tr>
        </thead>
         <tbody>
          {% for r in portal_rows %}
          <tr>
            <td>{{ r.Portal }}</td>
            <td>{{ r.Reservas }}</td>
            <td style="text-align:right">{{ r.PctReservas }}</td>
            <td style="text-align:right">{{ r.Ingresos }}</td>
          </tr>
          {% endfor %}
         </tbody>
       </table>
     </div>
   </div>

  <!-- NUEVO: RevPAR y Top months -->
  <div class="card" style="display:flex; gap:12px;">
    <div style="flex:1;">
      <div class="avoid-break-block">
        <h3>RevPAR (‚Ç¨/noche disponible)</h3>
        <table class="table" style="width:100%;">
          <thead><tr><th>ACT</th><th>LY</th></tr></thead>
          <tbody><tr><td>{{ revpar.act }}</td><td>{{ revpar.ly }}</td></tr></tbody>
        </table>
      </div>
    </div>
    <div style="flex:1;">
      <div class="avoid-break-block">
        <h3>Top meses (ingresos)</h3>
        <table class="table">
          <thead><tr><th>Mes</th><th>Ingresos</th></tr></thead>
          <tbody>
            {% for m in top_months %}
            <tr><td>{{ m.mes }}</td><td>{{ m.ing }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- NUEVO: Ocupaci√≥n por d√≠a de la semana -->
  <div class="card">
    <div class="avoid-break-block">
      <h3>Ocupaci√≥n media por d√≠a de la semana</h3>
      <table class="table">
        <thead><tr><th>D√≠a</th><th>Ocupaci√≥n</th></tr></thead>
        <tbody>
          {% for w in weekday_rows %}
          <tr><td>{{ w.day }}</td><td style="text-align:right">{{ w.pct }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- NUEVO: LOS y Antelaci√≥n (buckets) -->
  <div class="card">
    <div class="avoid-break-block">
      <h3>Estancia media y antelaci√≥n (buckets)</h3>
      <table class="table">
       <thead><tr><th>M√©trica</th><th>Valor</th></tr></thead>
       <tbody>
         <tr><td>LOS mediana</td><td>{{ los_median }} d√≠as</td></tr>
         <tr><td>LOS buckets</td>
           <td>
             1 noche: {{ los_buckets["1"] }} ¬∑ 2: {{ los_buckets["2"] }} ¬∑ 3-6: {{ los_buckets["3-6"] }} ¬∑ 7+: {{ los_buckets["7+"] }}
           </td>
         </tr>
         <tr><td>Antelaci√≥n buckets</td>
           <td>&lt;7d: {{ lead_buckets["<7d"] }} ¬∑ 7-30d: {{ lead_buckets["7-30d"] }} ¬∑ &gt;30d: {{ lead_buckets[">30d"] }}</td>
         </tr>
       </tbody>
      </table>
    </div>
  </div>

   <div class="card">
     <h3>Comentarios del Revenue Manager</h3>
     <div class="comments">{{ comments or '‚Äî' }}</div>
   </div>

  <!-- P√°gina final: Leyenda de t√©rminos (siempre en p√°gina nueva) -->
  <div class="card always-break" style="margin-top:10mm;">
    <h3>üìò Leyenda de t√©rminos</h3>
    <div style="font-size:11px; line-height:1.45;">
      <p><strong>ACT (Actual):</strong> Periodo actual analizado.</p>
      <p><strong>LY (Last Year):</strong> Mismo periodo del a√±o anterior.</p>
      <p><strong>Ingresos:</strong> Ingresos brutos generados por las reservas, sin incluir el importe de la limpieza.</p>
      <p><strong>ADR (Average Daily Rate):</strong> Precio medio por noche vendida.</p>
      <p><strong>Noches vendidas:</strong> Total de noches ocupadas.</p>
      <p><strong>LOS (Length of Stay):</strong> Estancia media en noches por reserva.</p>
      <p><strong>Antelaci√≥n:</strong> D√≠as medios entre la reserva y la llegada.</p>
      <p><strong>Ocupaci√≥n (%):</strong> Porcentaje de noches ocupadas sobre las noches disponibles.</p>
      <p><strong>RevPAR (Revenue per Available Room):</strong> Ingresos por noche disponible.</p>
      <p><strong>Reservas por portal:</strong> N√∫mero de reservas seg√∫n el canal de venta.</p>
      <p><strong>% reservas:</strong> Porcentaje de reservas que aporta cada canal.</p>
      <p><strong>Ingresos por portal:</strong> Facturaci√≥n generada por cada canal.</p>
      <p><strong>ADR por semana:</strong> Evoluci√≥n semanal del precio medio por noche.</p>
      <p><strong>Top meses (ingresos):</strong> Meses con mayor facturaci√≥n.</p>
      <p><strong>Ocupaci√≥n por d√≠a de la semana:</strong> Porcentaje medio de ocupaci√≥n seg√∫n el d√≠a.</p>
      <p><strong>LOS mediana:</strong> Duraci√≥n central de las estancias.</p>
      <p><strong>LOS buckets:</strong> Distribuci√≥n de reservas por duraci√≥n de estancia.</p>
      <p><strong>Antelaci√≥n buckets:</strong> Distribuci√≥n de reservas seg√∫n cu√°ndo se realizan.</p>
    </div>
  </div>
  </div>
</body>
</html>