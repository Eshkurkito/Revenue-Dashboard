<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Informe de propietario · {{ apto or '—' }}</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
         color:#111827; margin:0; padding:16px 18px; font-size:12px; }
  h1,h2,h3 { margin: 0 0 8px 0; }
  .muted { color:#6b7280; }
  .header { width:100%; margin-bottom:12px; border-bottom:1px solid #e5e7eb; padding-bottom:8px; }
  .header-table { width:100%; border-collapse:collapse; }
  .header-table td { vertical-align:middle; }
  .logo { height:100px; }
  .kpis { width:100%; border-collapse:separate; border-spacing:8px; margin:6px 0 8px 0; }
  .kpi { border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; background:#f8fafc; page-break-inside: avoid; }
  .kpi h4 { margin:0 0 4px 0; font-size:12px; color:#374151; }
  .kpi .v { font-size:18px; font-weight:700; }
  .kpi .ly { font-size:11px; color:#6b7280; }
  .card { border:1px solid #e5e7eb; border-radius:10px; padding:10px; page-break-inside: avoid; break-inside: avoid; margin-top:10px; }
  .card h3 { font-size:14px; margin:0 0 6px 0; color:#1f2937; }
  img.chart { width:100%; height:auto; border:1px solid #e5e7eb; border-radius:8px; display:block; }
  .chart-portal { width:100% !important; margin:0 auto; }  /* ← mitad de ancho y centrado */
  .table { width:100%; border-collapse:collapse; font-size:11.5px; page-break-inside:auto; break-inside:auto; }
  .table th, .table td { border:1px solid #e5e7eb; padding:6px 8px; }
  .table th { background:#f3f4f6; text-align:left; }
  .table tbody tr { page-break-inside: avoid; break-inside: avoid; } /* evitar cortar filas */
  .comments { white-space:pre-wrap; min-height:60px; }
  /* helpers para controlar saltos si más adelante hace falta forzar */
  .always-break { page-break-before: always; }
  .avoid-break { page-break-inside: avoid; break-inside: avoid; }
</style>
</head>
<body>

  <div class="header">
    <table class="header-table">
      <tr>
        <td>
          <h2>Informe de propietario</h2>
          <div class="muted">
            Apartamento: <b>{{ apto or '—' }}</b> · Propietario: <b>{{ owner or '—' }}</b><br>
            Periodo ACT: <b>{{ period_act }}</b> · Periodo LY: <b>{{ period_ly }}</b>
          </div>
        </td>
        <td style="text-align:right; width:180px;">
          {% if logo_b64 %}
            <img class="logo" src="data:image/png;base64,{{ logo_b64 }}" alt="Logo">
          {% endif %}
        </td>
      </tr>
    </table>
  </div>

  <table class="kpis">
    <tr>
      <td class="kpi">
        <h4>Ingresos (ACT)</h4>
        <div class="v">€{{ act.ingresos }}</div>
        <div class="ly">LY: €{{ ly.ingresos }}</div>
      </td>
      <td class="kpi">
        <h4>ADR (ACT)</h4>
        <div class="v">€{{ act.adr }}</div>
        <div class="ly">LY: €{{ ly.adr }}</div>
      </td>
      <td class="kpi">
        <h4>Noches vendidas (ACT)</h4>
        <div class="v">{{ act.noches }}</div>
        <div class="ly">LY: {{ ly.noches }}</div>
      </td>
    </tr>
  </table>

  <div class="card">
    <h3>Indicadores operativos</h3>
    <table class="table">
      <thead><tr><th>Estancia media (LOS)</th><th>Antelación media</th></tr></thead>
      <tbody><tr><td>{{ los_avg }} días</td><td>{{ lead_avg }} días</td></tr></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Reservas por portal (periodo)</h3>
    <table class="table">
      <thead><tr><th>Portal</th><th>Reservas</th></tr></thead>
      <tbody>
        {% for r in portal_rows %}
        <tr><td>{{ r.Portal }}</td><td>{{ r.Reservas }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h3>ADR por {{ gran_label }} (ACT vs LY)</h3>
    <img class="chart" src="data:image/png;base64,{{ chart_adr }}" alt="ADR">
  </div>

  <div class="card">
    <h3>Resumen ACT vs LY</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Serie</th>
          <th>Periodo</th>
          <th>Ingresos (€)</th>
          <th>ADR (€)</th>
          <th>Noches</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>ACT</td><td>{{ period_act }}</td><td>€{{ act.ingresos }}</td><td>€{{ act.adr }}</td><td>{{ act.noches }}</td></tr>
        <tr><td>LY</td><td>{{ period_ly }}</td><td>€{{ ly.ingresos }}</td><td>€{{ ly.adr }}</td><td>{{ ly.noches }}</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Tabla general: Desglose mensual de TODOS los alojamientos (primera) -->
  <h2 style="margin-top:4mm;">Desglose mensual</h2>
  <table style="width:100%; border-collapse:collapse; font-family: Arial, sans-serif; font-size:12px;">
    <thead>
      <tr style="background:#f2f2f2;">
        <th style="text-align:left; padding:6px; border:1px solid #ddd;">Mes</th>
        <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ingresos (ACT)</th>
        <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ingresos (LY)</th>
        <th style="text-align:right; padding:6px; border:1px solid #ddd;">ADR (ACT)</th>
        <th style="text-align:right; padding:6px; border:1px solid #ddd;">ADR (LY)</th>
        <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ocupación (ACT)</th>
        <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ocupación (LY)</th>
        <th style="text-align:right; padding:6px; border:1px solid #ddd;">Noches (ACT)</th>
        <th style="text-align:right; padding:6px; border:1px solid #ddd;">Noches (LY)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in monthly_rows %}
      <tr>
        <td style="padding:6px; border:1px solid #ddd;">{{ r.mes }}</td>
        <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ing_act }}</td>
        <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ing_ly }}</td>
        <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.adr_act }}</td>
        <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.adr_ly }}</td>
        <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ocup_act }}</td>
        <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ocup_ly }}</td>
        <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.nights_act }}</td>
        <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.nights_ly }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {# Si se solicitaron varios pisos, mostrar un desglose mensual por cada piso #}
  {% if monthly_by_property %}
    {% for mb in monthly_by_property %}
      <div class="card">
        <h3>Desglose mensual — {{ mb.apto }}</h3>
        <table style="width:100%; border-collapse:collapse; font-family: Arial, sans-serif; font-size:12px;">
          <thead>
            <tr style="background:#f2f2f2;">
              <th style="text-align:left; padding:6px; border:1px solid #ddd;">Mes</th>
              <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ingresos (ACT)</th>
              <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ingresos (LY)</th>
              <th style="text-align:right; padding:6px; border:1px solid #ddd;">ADR (ACT)</th>
              <th style="text-align:right; padding:6px; border:1px solid #ddd;">ADR (LY)</th>
              <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ocupación (ACT)</th>
              <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ocupación (LY)</th>
              <th style="text-align:right; padding:6px; border:1px solid #ddd;">Noches (ACT)</th>
              <th style="text-align:right; padding:6px; border:1px solid #ddd;">Noches (LY)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in mb.monthly_rows %}
            <tr>
              <td style="padding:6px; border:1px solid #ddd;">{{ r.mes }}</td>
              <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ing_act }}</td>
              <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ing_ly }}</td>
              <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.adr_act }}</td>
              <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.adr_ly }}</td>
              <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ocup_act }}</td>
              <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ocup_ly }}</td>
              <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.nights_act }}</td>
              <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.nights_ly }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Tabla unificada: Reservas por portal + Ingresos + Share -->
  <div class="card">
    <h3>Reservas por portal (periodo)</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Portal</th>
          <th>Reservas</th>
          <th style="text-align:right">% reservas</th>
          <th style="text-align:right">Ingresos</th>
        </tr>
      </thead>
       <tbody>
        {% for r in portal_rows %}
        <tr>
          <td>{{ r.Portal }}</td>
          <td>{{ r.Reservas }}</td>
          <td style="text-align:right">{{ r.PctReservas }}</td>
          <td style="text-align:right">{{ r.Ingresos }}</td>
        </tr>
        {% endfor %}
       </tbody>
     </table>
   </div>

  <!-- NUEVO: RevPAR y Top months -->
  <div class="card" style="display:flex; gap:12px;">
    <div style="flex:1;">
      <h3>RevPAR (€/noche disponible)</h3>
      <table class="table" style="width:100%;">
        <thead><tr><th>ACT</th><th>LY</th></tr></thead>
        <tbody><tr><td>{{ revpar.act }}</td><td>{{ revpar.ly }}</td></tr></tbody>
      </table>
    </div>
    <div style="flex:1;">
      <h3>Top meses (ingresos)</h3>
      <table class="table">
        <thead><tr><th>Mes</th><th>Ingresos</th></tr></thead>
        <tbody>
          {% for m in top_months %}
          <tr><td>{{ m.mes }}</td><td>{{ m.ing }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- NUEVO: Ocupación por día de la semana -->
  <div class="card">
    <h3>Ocupación media por día de la semana</h3>
    <table class="table">
      <thead><tr><th>Día</th><th>Ocupación</th></tr></thead>
      <tbody>
        {% for w in weekday_rows %}
        <tr><td>{{ w.day }}</td><td style="text-align:right">{{ w.pct }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- NUEVO: LOS y Antelación (buckets) -->
  <div class="card">
    <h3>Estancia media y antelación (buckets)</h3>
    <table class="table">
      <thead><tr><th>Métrica</th><th>Valor</th></tr></thead>
      <tbody>
        <tr><td>LOS mediana</td><td>{{ los_median }} días</td></tr>
        <tr><td>LOS buckets</td>
          <td>
            1 noche: {{ los_buckets["1"] }} · 2: {{ los_buckets["2"] }} · 3-6: {{ los_buckets["3-6"] }} · 7+: {{ los_buckets["7+"] }}
          </td>
        </tr>
        <tr><td>Antelación buckets</td>
          <td>&lt;7d: {{ lead_buckets["<7d"] }} · 7-30d: {{ lead_buckets["7-30d"] }} · &gt;30d: {{ lead_buckets[">30d"] }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h3>Comentarios del Revenue Manager</h3>
    <div class="comments">{{ comments or '—' }}</div>
  </div>

</body>
</html>