<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Informe de propietario ¬∑ {{ apto or '‚Äî' }}</title>
<style>
  /* Inter embebida + fallback por ruta local */
  {% if inter400_uri or inter400_b64 %}
  @font-face{
    font-family:"Inter";
    font-style:normal;
    font-weight:400;
    src:
      {% if inter400_uri %} url("{{ inter400_uri }}") format("truetype"), {% endif %}
      {% if inter400_b64 %} url(data:application/font-ttf;base64,{{ inter400_b64 }}) format("truetype"), {% endif %}
      local("Inter");
  }
  {% endif %}
  {% if inter600_uri or inter600_b64 %}
  @font-face{
    font-family:"Inter";
    font-style:normal;
    font-weight:600;
    src:
      {% if inter600_uri %} url("{{ inter600_uri }}") format("truetype"), {% endif %}
      {% if inter600_b64 %} url(data:application/font-ttf;base64,{{ inter600_b64 }}) format("truetype"), {% endif %}
      local("Inter");
  }
  {% endif %}
  {% if inter700_uri or inter700_b64 %}
  @font-face{
    font-family:"Inter";
    font-style:normal;
    font-weight:700;
    src:
      {% if inter700_uri %} url("{{ inter700_uri }}") format("truetype"), {% endif %}
      {% if inter700_b64 %} url(data:application/font-ttf;base64,{{ inter700_b64 }}) format("truetype"), {% endif %}
      local("Inter");
  }
  {% endif %}

  body{ font-family:"Inter","Segoe UI",Roboto,"Helvetica Neue",Arial,system-ui,-apple-system; }
  h1,h2,h3 { font-weight:700; }
  .table th { font-weight:600; }

  /* Fuente y paleta */
  /* Si wkhtmltopdf permite recursos remotos, puedes descomentar:
     @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap'); */
  :root{
    --bg: #ffffff;
    --text: #0f172a;      /* slate-900 */
    --muted: #64748b;     /* slate-500 */
    --border: #e2e8f0;    /* slate-200 */
    --header: #111827;    /* gray-900 */
    --th: #f8fafc;        /* slate-50 */
    --row-alt: #fbfdff;   /* very light for zebra */
    --accent: #2e485f;    /* azul corporativo del progress */
    --card-bg: #ffffff;
  }

  * { box-sizing: border-box; }

  body {
    font-family: "Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial, system-ui, -apple-system;
    color: var(--text);
    background: var(--bg);
    margin: 0;
    padding: 16px 18px;
    font-size: 11.75px;
    line-height: 1.5;
  }

  h1,h2,h3{
    margin: 0 0 10px 0;
    font-weight: 700;
    color: var(--header);
    letter-spacing: -0.01em;
  }
  .muted { color: var(--muted); font-size: 11.25px; }

  /* Header + logo */
  .header {
    width: 100%;
    margin-bottom: 14px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 12px;
    position: relative;
    min-height: 150px;
  }
  .header-logo {
    position: absolute;
    top: -8px;
    right: 4px;
    height: 140px;
    max-width: 300px;
    object-fit: contain;
  }
  .header-table { width: 100%; border-collapse: collapse; }
  .header-table td { vertical-align: middle; }
  .logo { height: auto; }

  /* KPIs */
  .kpis { width: 100%; border-collapse: separate; border-spacing: 10px; margin: 8px 0 10px 0; }
  .kpi{
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 14px;
    box-shadow: 0 1px 2px rgba(15,23,42,.04);
  }
  .kpi h4{
    margin: 0 0 6px 0;
    font-size: 11px;
    color: #334155;               /* slate-700 */
    text-transform: uppercase;
    letter-spacing: .02em;
  }
  .kpi .v { font-size: 19px; font-weight: 700; color: #0f172a; }
  .kpi .ly{ font-size: 11px; color: var(--muted); }

  /* Cards */
  .card{
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    margin-top: 12px;
    box-shadow: 0 1px 2px rgba(15,23,42,.04);
    page-break-inside: avoid;
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    -webkit-page-break-inside: avoid;
    overflow: visible;
  }
  .card h3 { font-size: 14px; margin: 0 0 8px 0; color: var(--header); }
  .always-break { page-break-before: always; }

  /* Tablas */
  .table{
    width: 100%;
    border-collapse: collapse;
    font-size: 11.5px;
    color: var(--text);
    table-layout: auto;
  }
  .table th, .table td { border: 1px solid var(--border); padding: 7px 10px; }
  .table th{
    background: var(--th);
    text-align: left;
    font-weight: 600;
    color: #111827;
  }
  .table tbody tr:nth-child(even){ background: var(--row-alt); }
  .table tbody tr { page-break-inside: avoid; break-inside: avoid; -webkit-column-break-inside: avoid; }

  /* Gr√°ficos */
  img.chart{
    width: 100%;
    height: auto;
    border: 1px solid var(--border);
    border-radius: 10px;
    display: block;
  }
  .chart-portal { width: 100% !important; margin: 0 auto; }

  /* Bloques no divisibles */
  .avoid-break-block{
    display: inline-block;
    width: 100%;
    page-break-inside: avoid;
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    -webkit-page-break-inside: avoid;
  }
  .avoid-break-block > h3{ page-break-after: avoid; margin-bottom: 8px; }

  /* Saltos controlados */
  .start-new-page { page-break-before: always; -webkit-page-break-before: always; }
  .break-after     { page-break-after: always; -webkit-page-break-after: always; }

  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }
  tbody { display: table-row-group; }

  .comments { white-space: pre-wrap; min-height: 60px; }

  @media print {
    body { padding: 12px; }
    .card { box-shadow: none; }
  }
</style>
</head>
<body>
  {%- macro paginated_block(title, headers, rows, cols, rows_per_page=20, table_classes='table', repeat_title=false) -%}
    {%- for start in range(0, rows|length, rows_per_page) -%}
      <div class="avoid-break-block" style="margin-bottom:6px;">
        {%- if repeat_title or loop.first -%}<h3>{{ title }}</h3>{%- endif -%}
        <table class="{{ table_classes }}" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              {%- for h in headers -%}
                <th style="text-align:{{ h.align|default('left') }}; padding:6px; border:1px solid #e5e7eb;">{{ h.label }}</th>
              {%- endfor -%}
            </tr>
          </thead>
          <tbody>
            {%- for r in rows[start:start+rows_per_page] -%}
              <tr>
                {%- for c in cols -%}
                  <td style="text-align:{{ c.align|default('left') }}; padding:6px; border:1px solid #e5e7eb;">
                    {{ r[c.key] }}
                  </td>
                {%- endfor -%}
              </tr>
            {%- endfor -%}
          </tbody>
        </table>
      </div>
      {%- if start + rows_per_page < rows|length -%}
        <div style="page-break-after: always;"></div>
      {%- endif -%}
    {%- endfor -%}
  {%- endmacro -%}

  {# Definiciones de columnas/headers para el desglose mensual #}
  {% set monthly_headers = [
    {'label':'Mes'},
    {'label':'Ingresos (ACT)','align':'right'},
    {'label':'Ingresos (LY)','align':'right'},
    {'label':'Previsi√≥n','align':'right'},
    {'label':'ADR (ACT)','align':'right'},
    {'label':'ADR (LY)','align':'right'},
    {'label':'Ocupaci√≥n (ACT)','align':'right'},
    {'label':'Ocupaci√≥n (LY)','align':'right'},
    {'label':'Noches (ACT)','align':'right'},
    {'label':'Noches (LY)','align':'right'}
  ] %}
  {% set monthly_cols = [
    {'key':'mes'},
    {'key':'ing_act','align':'right'},
    {'key':'ing_ly','align':'right'},
    {'key':'forecast','align':'right'},
    {'key':'adr_act','align':'right'},
    {'key':'adr_ly','align':'right'},
    {'key':'ocup_act','align':'right'},
    {'key':'ocup_ly','align':'right'},
    {'key':'nights_act','align':'right'},
    {'key':'nights_ly','align':'right'}
  ] %}
  <!-- full-bleed removed (background now white) -->
  <div class="sheet">
  <div class="header">
    <table class="header-table">
      <tr>
        <td>
          <h2>Informe de propietario</h2>
          <div class="muted">
            Apartamento: <b>{{ apto or '‚Äî' }}</b> ¬∑ Propietario: <b>{{ owner or '‚Äî' }}</b><br>
            Periodo ACT: <b>{{ period_act }}</b> ¬∑ Periodo LY: <b>{{ period_ly }}</b>
          </div>

          <!-- Progreso ingresos vs previsi√≥n -->
          <div style="margin-top:8px;">
            <div style="font-size:12px; color:#374151; margin-bottom:4px;">
              Ingresos ACT: <strong>{{ act.ingresos }}</strong> ¬∑ Previsi√≥n periodo: <strong>{{ forecast_total }}</strong> ¬∑ <strong>{{ forecast_progress_pct }}</strong>
            </div>
            <div style="background:#e5e7eb; border-radius:8px; height:12px; width:280px;">
              <table style="height:12px; width:100%; border-collapse:collapse; table-layout:fixed;">
                <tr>
                  <td width="{{ forecast_progress_pct }}" style="background:#2e485f; height:12px; border-radius:8px;"></td>
                  <td style="background:transparent; height:12px;"></td>
                </tr>
              </table>
            </div>
          </div>

        </td>
        <td style="text-align:right; width:180px;">
          {% if logo_b64 %}
            <img class="header-logo" src="data:image/png;base64,{{ logo_b64 }}" alt="Logo">
          {% endif %}
        </td>
      </tr>
    </table>
  </div>

  <table class="kpis">
    <tr>
      <td class="kpi">
        <h4>Ingresos (ACT)</h4>
        <div class="v">{{ act.ingresos }}</div>
        <div class="ly">LY: {{ ly.ingresos }}</div>
      </td>
      <td class="kpi">
        <h4>ADR (ACT)</h4>
        <div class="v">{{ act.adr }}</div>
        <div class="ly">LY: {{ ly.adr }}</div>
      </td>
      <td class="kpi">
        <h4>Noches vendidas (ACT)</h4>
        <div class="v">{{ act.noches }}</div>
        <div class="ly">LY: {{ ly.noches }}</div>
      </td>
    </tr>
  </table>

  <div class="card">
    <div class="avoid-break-block">
      <h3>Indicadores operativos</h3>
      <table class="table">
        <thead><tr><th>Estancia media (LOS)</th><th>Antelaci√≥n media</th></tr></thead>
        <tbody><tr><td>{{ los_avg }} d√≠as</td><td>{{ lead_avg }} d√≠as</td></tr></tbody>
      </table>
    </div>
  </div>
  
  <div class="card">
    <div class="avoid-break-block">
      <h3>Reservas por portal (periodo)</h3>
      <table class="table">
        <thead><tr><th>Portal</th><th>Reservas</th></tr></thead>
        <tbody>
          {% for r in portal_rows %}
          <tr><td>{{ r.Portal }}</td><td>{{ r.Reservas }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="card">
    <h3>ADR por {{ gran_label }} (ACT vs LY)</h3>
    <img class="chart" src="data:image/png;base64,{{ chart_adr }}" alt="ADR">
  </div>

  <!-- Separar en dos tarjetas para que no se corten entre p√°ginas -->
  <div class="card break-after">
    <div class="avoid-break-block">
      <h3>Top meses (ingresos)</h3>
      <table class="table">
        <thead><tr><th>Mes</th><th>Ingresos</th></tr></thead>
        <tbody>
          {% for m in top_months %}
          <tr><td>{{ m.mes }}</td><td>{{ m.ing }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card avoid-break-block start-new-page" style="margin-top:4mm;">
    {{ paginated_block('Desglose mensual', monthly_headers, monthly_rows, monthly_cols, rows_per_page=20, table_classes='table', repeat_title=false) }}
  </div>

  {% if monthly_by_property %}
    {% for mb in monthly_by_property %}
      <div class="card">
        <div class="avoid-break-block">
           {{ paginated_block('Desglose mensual ‚Äî ' ~ mb.apto, monthly_headers, mb.monthly_rows, monthly_cols, rows_per_page=18, table_classes='table', repeat_title=false) }}
+        </div>
       </div>
    {% endfor %}
  {% endif %}

  <!-- Tabla unificada: Reservas por portal + Ingresos + Share -->
  <div class="card">
    <div class="avoid-break-block">
      <h3>Reservas por portal (periodo)</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Portal</th>
            <th>Reservas</th>
            <th style="text-align:right">% reservas</th>
            <th style="text-align:right">Ingresos</th>
          </tr>
        </thead>
         <tbody>
          {% for r in portal_rows %}
          <tr>
            <td>{{ r.Portal }}</td>
            <td>{{ r.Reservas }}</td>
            <td style="text-align:right">{{ r.PctReservas }}</td>
            <td style="text-align:right">{{ r.Ingresos }}</td>
          </tr>
          {% endfor %}
         </tbody>
       </table>
     </div>
   </div>

   <div class="card">
     <h3>Comentarios del Revenue Manager</h3>
     <div class="comments">{{ comments or '‚Äî' }}</div>
   </div>

  <!-- P√°gina final: Leyenda de t√©rminos (siempre en p√°gina nueva) -->
  <div class="card always-break" style="margin-top:10mm;">
    <h3>üìò Leyenda de t√©rminos</h3>
    <div style="font-size:11px; line-height:1.45;">
      <p><strong>ACT (Actual):</strong> Periodo actual analizado.</p>
      <p><strong>LY (Last Year):</strong> Mismo periodo del a√±o anterior.</p>
      <p><strong>Ingresos:</strong> Ingresos brutos generados por las reservas, sin incluir el importe de la limpieza.</p>
       <p><em>Nota metodol√≥gica:</em> los ingresos se reconocen por fecha de estancia. Las reservas que abarcan varios meses se prorratean seg√∫n el n√∫mero de noches que cae en cada mes. Por esta imputaci√≥n y ajustes operativos, pueden existir ligeras diferencias entre la suma de ingresos por portal y el total del periodo.</p>
      <p><strong>ADR (Average Daily Rate):</strong> Precio medio por noche vendida.</p>
      <p><strong>Noches vendidas:</strong> Total de noches ocupadas.</p>
      <p><strong>LOS (Length of Stay):</strong> Estancia media en noches por reserva.</p>
      <p><strong>Antelaci√≥n:</strong> D√≠as medios entre la reserva y la llegada.</p>
      <p><strong>Ocupaci√≥n (%):</strong> Porcentaje de noches ocupadas sobre las noches disponibles.</p>
      <p><strong>RevPAR (Revenue per Available Room):</strong> Ingresos por noche disponible.</p>
      <p><strong>Reservas por portal:</strong> N√∫mero de reservas seg√∫n el canal de venta.</p>
      <p><strong>% reservas:</strong> Porcentaje de reservas que aporta cada canal.</p>
      <p><strong>Ingresos por portal:</strong> Facturaci√≥n generada por cada canal.</p>
      <p><strong>ADR por semana:</strong> Evoluci√≥n semanal del precio medio por noche.</p>
      <p><strong>Top meses (ingresos):</strong> Meses con mayor facturaci√≥n.</p>
      <p><strong>Ocupaci√≥n por d√≠a de la semana:</strong> Porcentaje medio de ocupaci√≥n seg√∫n el d√≠a.</p>
      <p><strong>LOS mediana:</strong> Duraci√≥n central de las estancias.</p>
      <p><strong>LOS buckets:</strong> Distribuci√≥n de reservas por duraci√≥n de estancia.</p>
      <p><strong>Antelaci√≥n buckets:</strong> Distribuci√≥n de reservas seg√∫n cu√°ndo se realizan.</p>
    </div>
  </div>
  </div>
</body>
</html>