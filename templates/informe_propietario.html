<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Informe de propietario ¬∑ {{ apto or '‚Äî' }}</title>
<style>
  * { box-sizing: border-box; }

  :root{
    --bg: #f7f9fb;
    --card-bg: #ffffff;
    --primary: #17384a;
    --primary-soft: #e9f1f6;
    --accent: #b2874a;
    --muted: #6b7280;
    --border: #e6eef3;
    --text: #0f1724;
  }

  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color: var(--text);
    background: var(--bg);
    margin: 0;
    padding: 20px;
    font-size: 12.5px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  h1,h2,h3,h4{ margin:0 0 8px 0; font-weight:600; color: #122029; }
  h2{ font-size:18px }
  h3{ font-size:14px }
  h4{ font-size:11.5px }

  .muted { color:var(--muted); font-size:11.5px; }

  /* header */
  .header{ border-bottom:1px solid rgba(18,32,41,0.06); padding-bottom:12px; margin-bottom:16px; }
  .header-table{ width:100%; border-collapse:collapse; }
  .header-table td{ vertical-align:top; }
  .logo{ height:104px; }

  /* KPIs */
  .kpis{ width:100%; border-collapse:separate; border-spacing:12px; margin:12px 0 18px; }
  .kpi{
    background: linear-gradient(180deg, var(--card-bg), #fbfcfd);
    border-radius:14px;
    padding:14px 16px;
    box-shadow: 0 6px 18px rgba(15,23,36,0.05);
    border: 1px solid rgba(17,24,39,0.04);
  }
  .kpi h4{ color:var(--muted); font-weight:600; }
  .kpi .v{ font-size:20px; font-weight:700; color:var(--primary); }
  .kpi .ly{ font-size:11px; color:var(--muted); margin-top:4px; }

  /* cards */
  .card{
    background: var(--card-bg);
    border-radius:14px;
    padding:14px;
    margin-top:14px;
    border: 1px solid var(--border);
    box-shadow: 0 10px 30px rgba(15,23,36,0.04);
    page-break-inside: avoid;
    break-inside: avoid;
  }
  .card h3{ margin-bottom:8px; color:#122029; }

  /* tables (softer, premium) */
  .table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    font-size:11.5px;
    color:#122029;
  }
  .table th,
  .table td{
    padding:8px 10px;
    vertical-align:middle;
    border-bottom: 1px solid rgba(17,24,39,0.04);
  }
  .table th{
    background: linear-gradient(180deg, var(--primary-soft), rgba(234,243,249,0.6));
    color:#122029;
    font-weight:600;
    text-align:left;
    border-top-left-radius:6px;
    border-top-right-radius:6px;
    border-bottom: 1px solid rgba(17,24,39,0.06);
  }
  .table td{ background: transparent; }
  .table tbody tr:nth-child(even) td{ background: rgba(15,23,36,0.015); }

  /* progress bar */
  .progress-track{
    background: rgba(15,23,36,0.06);
    border-radius:8px;
    height:12px;
    width:280px;
    overflow:hidden;
  }
  .progress-fill{
    background: linear-gradient(90deg, var(--primary), var(--accent));
    height:100%;
    border-radius:8px 0 0 8px;
  }

  /* charts */
  img.chart{ width:100%; height:auto; border-radius:10px; border:1px solid var(--border); }

  /* comments */
  .comments{
    white-space:pre-wrap;
    min-height:72px;
    background: linear-gradient(180deg,#fafdfd,#ffffff);
    border:1px dashed rgba(17,24,39,0.04);
    border-radius:10px;
    padding:12px;
    font-size:11.2px;
    color:var(--muted);
  }

  /* page-break control: treat entire card as atomic block */
  .avoid-break-block{ display:block; page-break-inside:avoid; break-inside:avoid; }
  thead{ display:table-header-group; }
  tbody tr{ page-break-inside:avoid; }

  /* small responsive tweaks for PDF layout */
  @media print{
    .card{ box-shadow:none; border-color:rgba(17,24,39,0.03); }
    .kpi .v{ font-size:18px; }
  }
</style>
</head>
<body>

  <div class="header">
    <table class="header-table">
      <tr>
        <td>
          <h2>Informe de propietario</h2>
          <div class="muted">
            Apartamento: <b>{{ apto or '‚Äî' }}</b> ¬∑ Propietario: <b>{{ owner or '‚Äî' }}</b><br>
            Periodo ACT: <b>{{ period_act }}</b> ¬∑ Periodo LY: <b>{{ period_ly }}</b>
          </div>

          <!-- Progreso ingresos vs previsi√≥n -->
          <div style="margin-top:8px;">
            <div style="font-size:12px; color:#374151; margin-bottom:4px;">
              Ingresos ACT: <strong>{{ act.ingresos }}</strong> ¬∑ Previsi√≥n periodo: <strong>{{ forecast_total }}</strong> ¬∑ <strong>{{ forecast_progress_pct }}</strong>
            </div>
            <div style="background:#e5e7eb; border-radius:8px; height:12px; width:280px;">
              <table style="height:12px; width:100%; border-collapse:collapse; table-layout:fixed;">
                <tr>
                  <td width="{{ forecast_progress_pct }}" style="background:#2e485f; height:12px; border-radius:8px;"></td>
                  <td style="background:transparent; height:12px;"></td>
                </tr>
              </table>
            </div>
          </div>

        </td>
        <td style="text-align:right; width:180px;">
          {% if logo_b64 %}
            <img class="logo" src="data:image/png;base64,{{ logo_b64 }}" alt="Logo">
          {% endif %}
        </td>
      </tr>
    </table>
  </div>

  <table class="kpis">
    <tr>
      <td class="kpi">
        <h4>Ingresos (ACT)</h4>
        <div class="v">{{ act.ingresos }}</div>
        <div class="ly">LY: {{ ly.ingresos }}</div>
      </td>
      <td class="kpi">
        <h4>ADR (ACT)</h4>
        <div class="v">{{ act.adr }}</div>
        <div class="ly">LY: {{ ly.adr }}</div>
      </td>
      <td class="kpi">
        <h4>Noches vendidas (ACT)</h4>
        <div class="v">{{ act.noches }}</div>
        <div class="ly">LY: {{ ly.noches }}</div>
      </td>
    </tr>
  </table>

  <div class="card">
    <div class="avoid-break-block">
      <h3>Indicadores operativos</h3>
      <table class="table">
        <thead><tr><th>Estancia media (LOS)</th><th>Antelaci√≥n media</th></tr></thead>
        <tbody><tr><td>{{ los_avg }} d√≠as</td><td>{{ lead_avg }} d√≠as</td></tr></tbody>
      </table>
    </div>
  </div>
  
  <div class="card">
    <div class="avoid-break-block">
      <h3>Reservas por portal (periodo)</h3>
      <table class="table">
        <thead><tr><th>Portal</th><th>Reservas</th></tr></thead>
        <tbody>
          {% for r in portal_rows %}
          <tr><td>{{ r.Portal }}</td><td>{{ r.Reservas }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="card">
    <h3>ADR por {{ gran_label }} (ACT vs LY)</h3>
    <img class="chart" src="data:image/png;base64,{{ chart_adr }}" alt="ADR">
  </div>

  <div class="card avoid-break-block" style="margin-top:4mm;">
    <div class="avoid-break-block">
      <h3>Desglose mensual</h3>
      <table class="table" style="width:100%; border-collapse:collapse; font-family: Arial, sans-serif; font-size:12px;">
       <thead>
         <tr style="background:#f2f2f2;">
           <th style="text-align:left; padding:6px; border:1px solid #ddd;">Mes</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ingresos (ACT)</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ingresos (LY)</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">Previsi√≥n</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">ADR (ACT)</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">ADR (LY)</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ocupaci√≥n (ACT)</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ocupaci√≥n (LY)</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">Noches (ACT)</th>
           <th style="text-align:right; padding:6px; border:1px solid #ddd;">Noches (LY)</th>
         </tr>
       </thead>
       <tbody>
         {% for r in monthly_rows %}
         <tr>
           <td style="padding:6px; border:1px solid #ddd;">{{ r.mes }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ing_act }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ing_ly }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.forecast }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.adr_act }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.adr_ly }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ocup_act }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ocup_ly }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.nights_act }}</td>
           <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.nights_ly }}</td>
         </tr>
         {% endfor %}
       </tbody>
      </table>
    </div>
  </div>

  {# Si se solicitaron varios pisos, mostrar un desglose mensual por cada piso #}
   {% if monthly_by_property %}
     {% for mb in monthly_by_property %}
       <div class="card">
         <div class="avoid-break-block">
           <h3>Desglose mensual ‚Äî {{ mb.apto }}</h3>
           <table style="width:100%; border-collapse:collapse; font-family: Arial, sans-serif; font-size:12px;">
            <thead>
              <tr style="background:#f2f2f2;">
                <th style="text-align:left; padding:6px; border:1px solid #ddd;">Mes</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ingresos (ACT)</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ingresos (LY)</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">Previsi√≥n</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">ADR (ACT)</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">ADR (LY)</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ocupaci√≥n (ACT)</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">Ocupaci√≥n (LY)</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">Noches (ACT)</th>
                <th style="text-align:right; padding:6px; border:1px solid #ddd;">Noches (LY)</th>
              </tr>
            </thead>
            <tbody>
              {% for r in mb.monthly_rows %}
              <tr>
                <td style="padding:6px; border:1px solid #ddd;">{{ r.mes }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ing_act }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ing_ly }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.forecast }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.adr_act }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.adr_ly }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ocup_act }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.ocup_ly }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.nights_act }}</td>
                <td style="text-align:right; padding:6px; border:1px solid #ddd;">{{ r.nights_ly }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
         </div>
       </div>
     {% endfor %}
   {% endif %}

  <!-- Tabla unificada: Reservas por portal + Ingresos + Share -->
  <div class="card">
    <div class="avoid-break-block">
      <h3>Reservas por portal (periodo)</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Portal</th>
            <th>Reservas</th>
            <th style="text-align:right">% reservas</th>
            <th style="text-align:right">Ingresos</th>
          </tr>
        </thead>
         <tbody>
          {% for r in portal_rows %}
          <tr>
            <td>{{ r.Portal }}</td>
            <td>{{ r.Reservas }}</td>
            <td style="text-align:right">{{ r.PctReservas }}</td>
            <td style="text-align:right">{{ r.Ingresos }}</td>
          </tr>
          {% endfor %}
         </tbody>
       </table>
     </div>
   </div>

  <!-- NUEVO: RevPAR y Top months -->
  <div class="card" style="display:flex; gap:12px;">
    <div style="flex:1;">
      <div class="avoid-break-block">
        <h3>RevPAR (‚Ç¨/noche disponible)</h3>
        <table class="table" style="width:100%;">
          <thead><tr><th>ACT</th><th>LY</th></tr></thead>
          <tbody><tr><td>{{ revpar.act }}</td><td>{{ revpar.ly }}</td></tr></tbody>
        </table>
      </div>
    </div>
    <div style="flex:1;">
      <div class="avoid-break-block">
        <h3>Top meses (ingresos)</h3>
        <table class="table">
          <thead><tr><th>Mes</th><th>Ingresos</th></tr></thead>
          <tbody>
            {% for m in top_months %}
            <tr><td>{{ m.mes }}</td><td>{{ m.ing }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- NUEVO: Ocupaci√≥n por d√≠a de la semana -->
  <div class="card">
    <div class="avoid-break-block">
      <h3>Ocupaci√≥n media por d√≠a de la semana</h3>
      <table class="table">
        <thead><tr><th>D√≠a</th><th>Ocupaci√≥n</th></tr></thead>
        <tbody>
          {% for w in weekday_rows %}
          <tr><td>{{ w.day }}</td><td style="text-align:right">{{ w.pct }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- NUEVO: LOS y Antelaci√≥n (buckets) -->
  <div class="card">
    <div class="avoid-break-block">
      <h3>Estancia media y antelaci√≥n (buckets)</h3>
      <table class="table">
       <thead><tr><th>M√©trica</th><th>Valor</th></tr></thead>
       <tbody>
         <tr><td>LOS mediana</td><td>{{ los_median }} d√≠as</td></tr>
         <tr><td>LOS buckets</td>
           <td>
             1 noche: {{ los_buckets["1"] }} ¬∑ 2: {{ los_buckets["2"] }} ¬∑ 3-6: {{ los_buckets["3-6"] }} ¬∑ 7+: {{ los_buckets["7+"] }}
           </td>
         </tr>
         <tr><td>Antelaci√≥n buckets</td>
           <td>&lt;7d: {{ lead_buckets["<7d"] }} ¬∑ 7-30d: {{ lead_buckets["7-30d"] }} ¬∑ &gt;30d: {{ lead_buckets[">30d"] }}</td>
         </tr>
       </tbody>
      </table>
    </div>
  </div>

   <div class="card">
     <h3>Comentarios del Revenue Manager</h3>
     <div class="comments">{{ comments or '‚Äî' }}</div>
   </div>

  <!-- P√°gina final: Leyenda de t√©rminos (siempre en p√°gina nueva) -->
  <div class="card always-break" style="margin-top:10mm;">
    <h3>üìò Leyenda de t√©rminos</h3>
    <div style="font-size:11px; line-height:1.45;">
      <p><strong>ACT (Actual):</strong> Periodo actual analizado.</p>
      <p><strong>LY (Last Year):</strong> Mismo periodo del a√±o anterior.</p>
      <p><strong>Ingresos:</strong> Ingresos brutos generados por las reservas, sin incluir el importe de la limpieza.</p>
      <p><strong>ADR (Average Daily Rate):</strong> Precio medio por noche vendida.</p>
      <p><strong>Noches vendidas:</strong> Total de noches ocupadas.</p>
      <p><strong>LOS (Length of Stay):</strong> Estancia media en noches por reserva.</p>
      <p><strong>Antelaci√≥n:</strong> D√≠as medios entre la reserva y la llegada.</p>
      <p><strong>Ocupaci√≥n (%):</strong> Porcentaje de noches ocupadas sobre las noches disponibles.</p>
      <p><strong>RevPAR (Revenue per Available Room):</strong> Ingresos por noche disponible.</p>
      <p><strong>Reservas por portal:</strong> N√∫mero de reservas seg√∫n el canal de venta.</p>
      <p><strong>% reservas:</strong> Porcentaje de reservas que aporta cada canal.</p>
      <p><strong>Ingresos por portal:</strong> Facturaci√≥n generada por cada canal.</p>
      <p><strong>ADR por semana:</strong> Evoluci√≥n semanal del precio medio por noche.</p>
      <p><strong>Top meses (ingresos):</strong> Meses con mayor facturaci√≥n.</p>
      <p><strong>Ocupaci√≥n por d√≠a de la semana:</strong> Porcentaje medio de ocupaci√≥n seg√∫n el d√≠a.</p>
      <p><strong>LOS mediana:</strong> Duraci√≥n central de las estancias.</p>
      <p><strong>LOS buckets:</strong> Distribuci√≥n de reservas por duraci√≥n de estancia.</p>
      <p><strong>Antelaci√≥n buckets:</strong> Distribuci√≥n de reservas seg√∫n cu√°ndo se realizan.</p>
    </div>
  </div>
</body>
</html>